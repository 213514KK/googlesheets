---
title: "gspreadr Basic Usage"
author: "Joanna Zhao"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{gspreadr Basic Usage}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

__NOTE__: This has not been edited since the Great Refactor of Febrary 2015.

```{r load package}
library(gspreadr)
```

This vignette shows the basic functionality of `gspreadr`.

# User Authentication

In order to access your own spreadsheets (non-public), you must log in. There are 2 ways to do it in `gspreadr`. 

1.  `login("email", "password")` (if you really want to...)
2.  `authorize()` (recommended)

For the first time, `authorize()` will authenticate the user interactively. The user will be directed to a web browser where they will be asked to login to their Google account, and give `gspreadr` permission to access Sheets and Google Drive. Credentials will be cached and authentication will not be needed for subsequent requests/sessions as `httr` handles the storing and refreshing of tokens. (A `.httr-oauth` file will be left behind in the current working directory)

If you want to access a different account, run `authorize(new_user = TRUE)`, as this will delete the previously stored token and get a new one for the new account.

# Open a spreadsheet

Under the hood, `gspread` functions must access a spreadsheet with either public or private __visiblity__. Visibility determines whether or not authorization will be used for a request.

No authorization is used when visibility is set to "public", which will only work for spreadsheets that have been "Published to the Web". Note that requests with visibility set to "public" __will not work__ for spreadsheets that are made "Public on the web" from the "Visibility options" portion of the sharing dialog of a Google Sheets file. In summary, "Published to the web" and "Public on the web" are __different__ ways to share a spreadsheet.

Authorization is used when visibility is set to "private".

## For spreadsheets that have been published to the web

To access public spreadsheets, you will either need the key of the spreadsheet (as found in the URL) or the entire URL. 

```{r open public sheets, eval = FALSE}

pub_sheet <- open_by_key("1hS762lIJd2TRUTVOqoOP7g-h4MDQs6b2vhkTzohg8bE", visibility = "public")

pub_sheet <- open_by_url("https://docs.google.com/spreadsheets/d/1hS762lIJd2TRUTVOqoOP7g-h4MDQs6b2vhkTzohg8bE/pubhtml", visibility = "public")

```

## For private spreadsheets

Once you have authenticated, you can use `list_spreadsheets()` to remind yourself what spreadsheets are in your Google drive. A spreadsheet can be opened by its title.

```{r spreadsheet ops, eval = FALSE}
# list spreadsheet titles, owners, and time of last update
list_spreadsheets()

# list the spreadsheet key too
list_spreadsheets(show_key = TRUE)

ssheet <- open_spreadsheet("Gapminder")
```

```{r, include = FALSE, eval = FALSE}
ssheet <- open_by_url("https://docs.google.com/spreadsheets/d/1hS762lIJd2TRUTVOqoOP7g-h4MDQs6b2vhkTzohg8bE", visibility = "public")
```

This returns a spreadsheet object. You can get the spreadsheet id, title, time of last update, and the number and names of worksheets contained. 

```{r eval = FALSE}
# spreadsheet components
ssheet$sheet_id ; ssheet$sheet_title ; ssheet$updated ; ssheet$nsheets ; ssheet$ws_names
```

## Add or delete a spreadsheet

To add or delete a spreadsheet in your Google Drive, use `add_spreadsheet()` or `del_spreadsheet()` and simply pass in the title of the spreadsheet as a character string. The new spreadsheet by default will contain one worksheet titled "Sheet1".

```{r create and delete spreadsheet, eval = FALSE}
# Create a new spreadsheet by title
add_spreadsheet("New Spreadsheet")

# Move spreadsheet to trash
del_spreadsheet("New Spreadsheet")
```

# Open a worksheet

You can use `list_worksheets()` to see the worksheets living in a spreadsheet. This is a wrapper around `ssheet$ws_names`.
```{r list ws, eval = FALSE}

list_worksheets(ssheet)
```

To open a worksheet, you can pass in a spreadsheet object and then specify the worksheet using its title or index, or this can be done in one step using `open_at_once(ss_title, ws_index)`. This saves a bit of typing but the spreadsheet object will not be stored, so if you want to open another worksheet, `open_spreadsheet("title")` will be called again. So if you want to open multiple worksheets from a spreadsheet, it is best to open the spreadsheet and save the spreadsheet as an R object and call `open_worksheet(ss, x)`  

```{r open ws, eval = FALSE}
# by title
ws <- open_worksheet(ssheet, "Oceania")
```
```{r, eval=FALSE}
# or by index (starting at 1)
ws <- open_worksheet(ssheet, 5)

# or in one shot
ws <- open_at_once(ss_title = "Gapminder by Continent", ws_value = "Oceania")
ws <- open_at_once(ss_title = "Gapminder by Continent", ws_value = 5)
```

This returns a worksheet object. You can get the ids of the spreadsheet and worksheet, worksheet title, and the number of rows and columns.

```{r, eval = FALSE}
# worksheet components
ws$sheet_id ; ws$id ; ws$title ; ws$ncol ; ws$nrow
```

# Open multiple worksheets

You can open all the worksheets from a spreadsheet using `open_worksheets()` passing the spreadsheet object as the argument. This will return a list of worksheet objects which you can then use `plyr` functions to perform worksheet operations such as `get_cell()`, `get_row()`, `read_region()`, etc.   

```{r open multiple worksheets, eval = FALSE}

ws_objs <- open_worksheets(ssheet)

plyr::llply(ws_objs, function(x) get_cell(x, "A2"))

```

# Add or delete a worksheet

To add a worksheet to a spreadsheet, pass in the spreadsheet object, title of new worksheet and the number of rows and columns. To delete a worksheet from a spreadsheet, pass in the spreadsheet object and the title of the worksheet. Note that after adding or deleting a worksheet, the spreadsheet object will not be automatically updated to include the new worksheet(s) information, you must open the spreadsheet again to "refresh" it. 

```{r, eval = FALSE}
add_worksheet(ssheet, title = "foo", nrow = 10, ncol = 10)

del_worksheet(ssheet, ws_title = "foo")
```

# Rename a worksheet

To rename a worksheet, pass in the spreadsheet object, the worksheet's current name and the new name you want it to be.  

```{r eval = FALSE}
rename_worksheet(ssheet, "Sheet1", "First Sheet")
```

# Consuming data from a worksheet

Eventually, you may want to read parts of the [Google Sheets API version 3.0 documentation](https://developers.google.com/google-apps/spreadsheets/). The types of data access supported by the API determine what is possible and also what is (relatively) fast vs slow in the `gspreadr` package. The Sheets API uses the term "feed" much like other APIs will refer to an "endpoint".

There are two basic modes of consuming data stored in a worksheet (quotes taken from the [API docs](https://developers.google.com/google-apps/spreadsheets/):

  * the __list feed__: implicitly assumes data is in a neat rectangle, like an R matrix or data.frame, with a header row followed by one or more data rows, none of which are completely empty
    - "list row: Row of cells in a worksheet, represented as a key-value pair, where each key is a column name, and each value is the cell value. The first row of a worksheet is always considered the header row when using the API, and therefore is the row that defines the keys represented in each row."
  * the __cell feed__: unconstrained access to individual cells specified in either Excel-like notation, e.g. cell D9, or in row-number-column-number notation, e.g. R9C4
    - "cell: Single piece of data in a worksheet."



# Worksheet Operations

## View worksheet

You can take a look at your worksheets to get an idea of what it looks like. Use `view()` to look at one worksheet and `view_all()` to look at all worksheets contained in a spreadsheet. `view_all()` returns a gallery of all the worksheets. Set `show_overlay = TRUE` to view an overlay of all the worksheets to identify the density of the cells occupied by worksheets. **showing Error: could not find function "ggplotGrob"**

```{r, fig.width=7, fig.height=7, eval = FALSE}

view(ws)

view_all(ssheet)
```

## Display structure of spreadsheet and worksheet

To get a more detailed report of your worksheet, use `str()`. This function summarizes your worksheet by letting you know the number of rows and columns, empty cells, and the cell pattern per column (a string of ##V for values and ##NA for empty cells).
```{r display structure, eval = FALSE}

# str for a spreadsheet
str(ssheet)

# str for a worksheet
str(ws)

```

## Get data from a worksheet

You can get row(s), col(s), a region, or an entire worksheet. 

### Get row(s)
```{r get rows, eval = FALSE}
get_row(ws, 1)

get_rows(ws, from = 1, to = 3)
```

### Get col(s)

You can get columns either by integer or letter. 

```{r get cols, eval = FALSE}
head(get_col(ws, 1))

head(get_col(ws, "A"))

head(get_cols(ws, from = 1, to = 5))

head(get_cols(ws, from = "A", to = "E"))

```

### Get a region as a data frame

#### Specify by min/max rows and columns

You can get a region of a worksheet by specifying the boundary rows and columns. The first row will be taken as the `header` by default.

```{r get region, eval = FALSE}
read_region(ws, from_row = 1, to_row = 3, from_col = 1, to_col = 5)

# set header to FALSE
read_region(ws, from_row = 1, to_row = 3, from_col = 1, to_col = 5, header = FALSE)
```

#### Specify by range

You can also get a region of a worksheet by specifying the cell ranges as a character string. The first row will be taken as the `header` by default.

```{r get range, eval = FALSE}

read_range(ws, "A1:E5")

```


### Get the entire worksheet as data frame

You can get the entire worksheet. Empty cells will be filled with NAs. Boundaries are determined by the right-most and bottom-most cells that contain a value.  The first row will be taken as the `header` by default.


```{r get all, eval = FALSE}
read_all(ws)
```

### Get a cell

You can get the value of a specific cell. There are two notations you can use: `A1` and `R1C1`. For `A1` notation, columns are indicated by a letter followed by the row as an integer. For `R1C1` notation, integers represent the rows and columns, and are preceded by `R` or `C`. Note that `A1` and `R1C1` are equivalent.

```{r get cell, eval = FALSE}

get_cell(ws, "A1")

get_cell(ws, "R1C1")

```

### Find a cell

You can find the first position of the cell containing the specified value or all the cells that contain the specified value. 

```{r find cell, eval = FALSE}

find_cell(ws, "Australia")

find_all(ws, "Australia")

```

## Update cells

### Update a single cell

You can update a cell's value by specifying the cell's position, either in `A1` or `R1C1` notation, and the new value. The new value may be a formula followed by a `=`, ie. `=A1+B1`. 

```{r update cell, eval = FALSE}

update_cell(ws, "A1", "Oops")

get_cell(ws, "A1")

update_cell(ws, "R1C1", "country")

get_cell(ws, "R1C1")

```

### Update cells in batch

You can update a batch of cells by specifying the range (ie. "A1:A4"). Alternatively, if you just want to dump an entire dataframe or vector into a worksheet, you can specify an anchor cell as the reference cell position and the range will be calculated for you. You can pass in a vector of new values or an entire data frame.

```{r update cells, eval = FALSE}

update_cells(ws, "C1:E1", c("A", "B", "C"))

read_range(ws, "A1:F3")

update_cells(ws, "G1", head(iris))

read_range(ws, "G1:K7")
```

```{r return to orig, include = FALSE, eval = FALSE, eval = FALSE}

update_cells(ws, "C1:E1", c("pop", "continent", "lifeExp"))
update_cells(ws, "G1:K7", ncol(head(iris) * (nrow(iris) + 1)))
```

# Appendix: Visibility table

Accessing spreadsheets that are or are not "published to the web" with visibility set of "public" vs "private"


| Sheet Type           | Public? (Published to the web) | URL visibility setting | Response      | Content Type         | Content                |
|----------------------|--------------------------------|------------------------|---------------|----------------------|------------------------|
| My sheet             | Yes                            | private                | 200 OK        | application/atom+xml | data                   |
| My sheet             | Yes                            | public                 | 200 OK        | application/atom+xml | data                   |
| My sheet             | No                             | private                | 200 OK        | application/atom+xml | data                   |
| My sheet             | No                             | public                 | 200 OK        | text/html            | this doc is not public |
| Someone else's sheet | Yes                            | private                | 403 Forbidden | Error                | Error                  |
| Someone else's sheet | Yes                            | public                 | 200 OK        | application/atom+xml | data                   |
| Someone else's sheet | No                             | private                | 200 OK        | application/atom+xml | data                   |
| Someone else's sheet | No                             | public                 | 200 OK        | text/html            | this doc is not public |
